on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  update-changelog:
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Dependabot metadata
        id: meta
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Only handle @google/gemini-cli bump
        id: gate
        run: |
          set -euo pipefail
          echo "${{ steps.meta.outputs.dependency-names }}" | grep -q '@google/gemini-cli' || {
            exit 0
          }

      - name: Checkout Dependabot PR branch
        uses: actions/checkout@v5
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
          persist-credentials: true

      - name: Instal tools
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get update -y -q
          sudo apt-get --no-install-recommends --no-install-suggests install -y -q rpm-i18n jq git

      - name: Prepare and update changelog using rpmdev-bumpspec
        id: bump-spec
        env:
          NEW_VERSION: ${{ steps.meta.outputs.new-version }}
          LANG: C
        run: |
          set -euo pipefail
          
          curl -sLO 'https://pagure.io/rpmdevtools/raw/main/f/rpmdev-bumpspec'
          curl -sLO 'https://pagure.io/rpmdevtools/raw/main/f/rpmdev-packager'
          chmod +x rpmdev-bumpspec
          chmod +x rpmdev-packager
          sudo mv rpmdev-bumpspec /usr/bin/
          sudo mv rpmdev-packager /usr/bin/

          if [ -z "${NEW_VERSION:-}" ] || [ "${NEW_VERSION}" = "null" ]; then 
            NEW_VERSION="$(jq -r '.[]."@google/gemini-cli"' package.json)"
          fi

          if grep -qE "^[*] .* - ${NEW_VERSION}-" gemini-cli.spec; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          rpmdev-bumpspec \
            -u 'KOSHIKAWA Kenichi <reishoku.misc@pm.me>' \
            -d "$(env TZ='Asia/Tokyo' LC_TIME=C date '+%a %b %d %Y')" \
            -n "${NEW_VERSION}" \
            -c "Update to ${NEW_VERSION}" \
            gemini-cli.spec

          echo "changed=true" >> "$GITHUB_OUTPUT"
          echo "new_version=${NEW_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Commit and push
        if: steps.bump-spec.outputs.changed == 'true'
        env:
          NEW_VERSION: ${{ steps.meta.outputs.new-version }}
        run: |
          set -euo pipefail
          export NEW_VERSION="${{ steps.meta.outputs.new-version }}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add gemini-cli.spec
          git commit -m "rpm(spec): Update version to ${NEW_VERSION}"
          git tag "${NEW_VERSION}"
          git push origin --tags
